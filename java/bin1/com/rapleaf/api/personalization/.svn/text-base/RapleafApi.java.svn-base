package com.rapleaf.api.personalization;

import java.net.*;
import java.io.*;
import org.json.JSONObject;

public class RapleafApi {
  private String apiKey;
  private final static String BASE_URL = "https://personalize.rlcdn.com/v4/dr";
  private final static int TIMEOUT = 2000;
  
  public RapleafApi(String apiKey) {
    this.apiKey = apiKey;
  }
  
  public JSONObject queryByEmail(String email) throws Exception {
    String url = BASE_URL + "?email=" + email + "&api_key=" + apiKey;
    return getJsonResponse(url);
  }
  
  private JSONObject getJsonResponse(String urlStr) throws Exception {
    URL url = new URL(urlStr);
    HttpURLConnection handle = (HttpURLConnection)url.openConnection();
    handle.setRequestProperty("User-Agent", "RapleafApi/Java/1.0");
    handle.setConnectTimeout(TIMEOUT);
    handle.setReadTimeout(TIMEOUT);
    BufferedReader in = new BufferedReader(new InputStreamReader(handle.getInputStream()));
    String responseBody = in.readLine();
    in.close();
    int responseCode = handle.getResponseCode();
    if (responseCode < 200 || responseCode > 299) {
      throw new Exception("Error Code " + responseCode + ": " + responseBody);
    }
    if(responseBody == null || responseBody.equals("")) {
      responseBody = "{}";
    }
    return new JSONObject(responseBody);
  }
}	